# Define common configuration for resource limits
x-common-resources: &common-resources
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 8G
      reservations:
        cpus: "1"
        memory: 4G
  ulimits:
    core: 0
  environment:
    ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"

services:
  # -------------- Base Images --------------
  symcc:
    build:
      context: .
      dockerfile: symcc-common.Dockerfile
      args:
        LLVM_VERSION: 12
    image: symcc:latest

  symsan:
    build:
      context: .
      dockerfile: symsan-common.Dockerfile
    image: symsan:latest

  concolic:
    build:
      context: .
      dockerfile: concolic-common.Dockerfile
    image: concolic:latest

  klee:
    build:
      context: .
      dockerfile: klee-common.Dockerfile
    image: klee:latest

  klee-float:
    build:
      context: .
      dockerfile: klee-float-common.Dockerfile
    image: klee-float:latest

  aflplusplus:
    build:
      context: .
      dockerfile: aflplusplus-common.Dockerfile
    image: aflplusplus:latest

  # -------------- bc --------------
  bc-symcc:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: bc-symcc:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  bc-symsan:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: bc-symsan:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  bc-concolic:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: bc-concolic:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  bc-klee:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: bc-klee:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  bc-klee-pending:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: klee-pending.Dockerfile
    image: bc-klee-pending:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  bc-aflplusplus:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: bc-aflplusplus:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- oggenc --------------
  oggenc-symcc:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: oggenc-symcc:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  oggenc-symsan:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: oggenc-symsan:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  oggenc-concolic:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: oggenc-concolic:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  oggenc-klee:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: oggenc-klee:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  oggenc-klee-pending:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: klee-pending.Dockerfile
    image: oggenc-klee-pending:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  oggenc-aflplusplus:
    <<: *common-resources
    build:
      context: ./oggenc
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: oggenc-aflplusplus:latest
    volumes:
      - ./oggenc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- libsoup --------------
  libsoup-concolic:
    <<: *common-resources
    build:
      context: ./libsoup
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: libsoup-concolic:latest
    volumes:
      - ./libsoup/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  libsoup-aflplusplus:
    <<: *common-resources
    build:
      context: ./libsoup
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: libsoup-aflplusplus:latest
    volumes:
      - ./libsoup/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- libyaml --------------
  libyaml-symcc:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: libyaml-symcc:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  libyaml-symsan:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: libyaml-symsan:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  libyaml-concolic:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: libyaml-concolic:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  libyaml-klee:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: libyaml-klee:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  libyaml-klee-pending:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: klee-pending.Dockerfile
    image: libyaml-klee-pending:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  libyaml-aflplusplus:
    <<: *common-resources
    build:
      context: ./libyaml
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: libyaml-aflplusplus:latest
    volumes:
      - ./libyaml/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- libmatheval --------------
  libmatheval-symcc:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: libmatheval-symcc:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  libmatheval-symsan:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: libmatheval-symsan:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  libmatheval-concolic:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: libmatheval-concolic:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  libmatheval-klee:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: libmatheval-klee:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  libmatheval-klee-pending:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: klee-pending.Dockerfile
    image: libmatheval-klee-pending:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  libmatheval-aflplusplus:
    <<: *common-resources
    build:
      context: ./libmatheval
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: libmatheval-aflplusplus:latest
    volumes:
      - ./libmatheval/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- woff2 --------------
  woff2-symsan:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: woff2-symsan:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  woff2-symcc:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: woff2-symcc:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  woff2-concolic:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: woff2-concolic:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  woff2-aflplusplus:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: woff2-aflplusplus:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- krep --------------
  krep-concolic:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: krep-concolic:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  krep-klee:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: krep-klee:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  krep-klee-pending:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: klee-pending.Dockerfile
    image: krep-klee-pending:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  krep-symcc:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: krep-symcc:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  krep-symsan:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: krep-symsan:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  krep-aflplusplus:
    <<: *common-resources
    build:
      context: ./krep
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: krep-aflplusplus:latest
    volumes:
      - ./krep/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- confetti --------------
  confetti-concolic:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: confetti-concolic:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  confetti-klee:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: confetti-klee:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]

  confetti-klee-pending:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: klee-pending.Dockerfile
    image: confetti-klee-pending:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]

  confetti-symcc:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: confetti-symcc:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  confetti-symsan:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: confetti-symsan:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  confetti-aflplusplus:
    <<: *common-resources
    build:
      context: ./confetti
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: confetti-aflplusplus:latest
    volumes:
      - ./confetti/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]
